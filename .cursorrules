# native-audio-node Development Guide

## Project Overview

A TypeScript npm package that provides native audio capture for Node.js on macOS and Windows. The package uses platform-specific prebuilt binaries distributed via optional dependencies - **no node-gyp required** for end users.

## Monorepo Structure

```
native-audio-node/
├── packages/
│   ├── native-audio-node/       # Main TypeScript package
│   │   ├── src/
│   │   │   ├── index.ts         # Public exports
│   │   │   ├── binding.ts       # Native binding loader
│   │   │   ├── types.ts         # TypeScript types
│   │   │   ├── base-recorder.ts # Base class with polling
│   │   │   ├── system-audio-recorder.ts
│   │   │   ├── microphone-recorder.ts
│   │   │   ├── devices.ts       # Device enumeration
│   │   │   └── permission.ts    # Permission management
│   │   ├── package.json         # Has optionalDependencies
│   │   └── tsup.config.ts
│   │
│   ├── darwin-arm64/            # macOS Apple Silicon binary
│   │   ├── package.json         # @native-audio-node/darwin-arm64
│   │   └── native_audio.node    # Prebuilt binary
│   │
│   ├── darwin-x64/              # macOS Intel binary
│   │   ├── package.json         # @native-audio-node/darwin-x64
│   │   └── native_audio.node
│   │
│   ├── win32-x64/               # Windows x64 binary
│   │   ├── package.json         # @native-audio-node/win32-x64
│   │   └── native_audio.node
│   │
│   └── win32-arm64/             # Windows ARM64 binary
│       ├── package.json         # @native-audio-node/win32-arm64
│       └── native_audio.node
│
├── native/                       # Native source code (C++/Swift)
│   ├── napi/
│   │   └── audio_napi.cpp       # Node-API wrapper
│   ├── macos/
│   │   └── swift/               # Swift audio capture code
│   └── windows/
│       └── wasapi_capture.cpp   # WASAPI audio capture code
│
├── scripts/
│   └── copy-binary.js           # Copy built binary to platform package
│
├── CMakeLists.txt               # Native build configuration
├── package.json                 # Monorepo root (pnpm workspaces)
└── pnpm-workspace.yaml
```

## Key Technical Decisions

- **ESM-first package** (`"type": "module"` in package.json)
- **pnpm workspaces** for monorepo management
- **Platform-specific packages** via optionalDependencies (like esbuild, swc)
- **No build tools required** for end users - binaries are prebuilt
- **tsup for TypeScript bundling** (faster than tsc)
- **Node 20+ minimum** (using modern features)
- **cmake-js for native builds** (development only)

## How Binary Loading Works

1. User installs `native-audio-node`
2. npm automatically installs the matching platform package (e.g., `@native-audio-node/darwin-arm64`)
3. `binding.ts` detects platform/arch and requires the correct package
4. The platform package exports the `.node` binary directly

```typescript
// In binding.ts
const packageName = `@native-audio-node/${process.platform}-${process.arch}`
const addon = require(packageName)
```

## Development Workflow

### Building Native Code (Development)

```bash
# Install dependencies
pnpm install

# Build native addon
pnpm run build:native

# Copy binary to correct platform package
pnpm run copy-binary

# Build TypeScript
pnpm run build:ts

# Full build (native + copy + TypeScript)
pnpm run build
```

### Testing Locally

```bash
# After building, run examples
node examples/record-system.mjs
node examples/record-mic.mjs
```

### Publishing

Each package needs to be published separately:

```bash
# Publish platform packages first (with the correct binary)
cd packages/darwin-arm64 && npm publish --access public
cd packages/darwin-x64 && npm publish --access public
cd packages/win32-x64 && npm publish --access public
cd packages/win32-arm64 && npm publish --access public

# Then publish main package
cd packages/native-audio-node && npm publish
```

For CI/CD, use GitHub Actions matrix builds to compile for each platform.

## Native Addon Interface

The native addon exports:

```typescript
interface NativeAddon {
  // Recorder class
  AudioRecorderNative: new () => {
    startSystemAudio(options): void
    startMicrophone(options): void
    stop(): void
    isRunning(): boolean
    processEvents(): NativeEvent[]
  }

  // Device enumeration
  listDevices(): AudioDevice[]
  getDefaultInputDevice(): string | null
  getDefaultOutputDevice(): string | null

  // Permissions
  getSystemAudioPermissionStatus(): 'unknown' | 'denied' | 'authorized'
  isSystemAudioPermissionAvailable(): boolean
  requestSystemAudioPermission(callback): void
  getMicPermissionStatus(): 'unknown' | 'denied' | 'authorized'
  requestMicPermission(callback): void
  openSystemSettings(): boolean
}
```

## Platform Requirements

### macOS
- **macOS 14.2+** (Sonoma or later) for system audio capture
- Core Audio APIs for microphone
- TCC permission for system audio recording

### Windows
- **Windows 10 2004+** (Build 19041 or later)
- WASAPI for audio capture
- Process-specific loopback (limited to single PID)

## Audio Format

- **Format**: Raw PCM audio data
- **Channels**: Mono (1) or Stereo (2)
- **Sample rate**: Device native or converted (8kHz-48kHz)
- **Bit depth**: 32-bit float (default) or 16-bit int
- **Chunk timing**: 200ms default, configurable 0-5000ms
